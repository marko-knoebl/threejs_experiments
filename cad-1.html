<html>
	<head>
		<meta charset="utf-8">
		<title>My first Three.js app</title>
	</head>
	<body>
		<script src="http://threejs.org/build/three.min.js"></script>
		<script>
		"use strict";
		// a simple viewer with camera controls which has the z-axis vertical

		var scene, camera, renderer, render;
		var wireGeom, wireMat, wire;
		var cameraContainer;
		
		// this object represents the geometric model that is being edited
		var geoDoc = {};
		
		// all geometric objects
		geoDoc.objects = [];
		
		geoDoc.add = function(obj) {
			// add an object to the document and update the view accordingly
			this.objects.push(obj);
			scene.add(obj);
			renderer.render(scene, camera);
		};
		
		geoDoc.rem = function(obj) {
			var index = this.objects.indexOf(obj);
			var toRemove = this.objects.splice(index, 1)[0];
			scene.remove(toRemove);
			renderer.render(scene, camera);
		};
		
		var lmbdown; // left mouse button down
		
		// set the document style (CSS)
		document.body.style.margin = '0px';
		document.body.style.backgroundColor = '#eeeeee';
		document.body.style.fontFamily = 'Arimo, "Liberation Sans", Arial, Helvetica, sans-serif';
		document.body.style.fontSize = '16';
		
		// vertical split
		var leftSidebar = document.createElement('div');
		leftSidebar.style.cssFloat = 'left';
		leftSidebar.style.width = '200px';
		leftSidebar.style.backgroundColor = '#ffffff';
		document.body.appendChild(leftSidebar);
		
		var toolSelector = document.createElement('div');
		toolSelector.style.backgroundColor = '#ffffff';
		toolSelector.style.margin = '3px';
		leftSidebar.appendChild(toolSelector);
		
		var addToolButton = function(tool) {
			var newButton;
			newButton = document.createElement('button');
			newButton.style.margin = '3px';
			newButton.style.border = '0px';
			newButton.style.width = '58px';
			newButton.style.height = '58px';
			newButton.style.backgroundColor = '#1ba1e2';
			newButton.style.color = '#ffffff';
			newButton.style.fontSize = '12';
			newButton.innerHTML = tool.name;
			newButton.tool = tool;
			newButton.onclick = function() {activateTool(newButton.tool);};
			toolSelector.appendChild(newButton);
		}
		
		var toolOptions = document.createElement('div');
		toolOptions.style.backgroundColor = '#eeeeee';
		toolOptions.style.fontSize = '12';
		leftSidebar.appendChild(toolOptions);
		
		var buttonContainer = document.createElement('div');
		buttonContainer.style.textAlign = 'center';
		buttonContainer.style.padding = '6px';
		buttonContainer.style.backgroundColor = '#eeeeee';
		var addButton = document.createElement('button');
		var cancelButton = document.createElement('button');
		addButton.innerHTML = 'Add';
		cancelButton.innerHTML = 'Cancel';
		addButton.style.borderWidth = '1px';
		cancelButton.style.borderWidth = '1px';
		addButton.style.borderColor = '#ffffff';
		cancelButton.style.borderColor = '#ffffff';
		addButton.style.borderStyle = 'solid';
		cancelButton.style.borderStyle = 'solid';
		addButton.style.margin = '3px';
		cancelButton.style.margin = '3px';
		addButton.style.backgroundColor = '#1ba1e2';
		cancelButton.style.backgroundColor = '#126993';
		addButton.style.color = '#ffffff';
		cancelButton.style.color = '#ffffff';
		buttonContainer.appendChild(addButton);
		buttonContainer.appendChild(cancelButton);
		leftSidebar.appendChild(buttonContainer);
		addButton.addEventListener('click', function() {
			var newObject = preview.clone();
			newObject.material = mainMaterial;
			geoDoc.add(newObject);
			activateTool(selectTool);
		});
		cancelButton.addEventListener('click', function() {
			activateTool(selectTool);
		});
		
		// set up 3d view
		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera( 50, (window.innerWidth - 200) / window.innerHeight, 0.1, 1000 );
		renderer = new THREE.WebGLRenderer({antialias: true});
		renderer.setClearColor(0xf6f6f6, 1);
		renderer.setSize(window.innerWidth - 200, window.innerHeight);
		renderer.domElement.style.cssFloat = 'right';
		renderer.domElement.style.width = (window.innerWidth - 200).toString() + 'px';
		renderer.domElement.style.height = (window.innerHeight).toString() + 'px';
		document.body.appendChild( renderer.domElement );

		// set up the camera so the z-axis is vertical
		camera.rotation.order = 'ZYX';
		camera.rotation.set(Math.PI/2, 0, Math.PI/2);

		// make a container for the newly oriented camera to control its orientation
		cameraContainer = new THREE.Object3D();
		cameraContainer.add(camera);
		cameraContainer.position.set(20, 0, 0);
		cameraContainer.rotation.order = 'ZYX';
		cameraContainer.ang = {'_phi': 0, '_theta': 0};
		Object.defineProperty(cameraContainer.ang, 'phi', {
				get: function() {return cameraContainer.ang._phi;},
				set: function(phi_) {
					var theta_
					cameraContainer.ang._phi = phi_;
					theta_ = cameraContainer.ang._theta;
					cameraContainer.rotation.set(0, -cameraContainer.ang._theta, cameraContainer.ang._phi);
					cameraContainer.position.set(20 * Math.cos(phi_) * Math.cos(theta_), 20 * Math.sin(phi_) * Math.cos(theta_), 20 * Math.sin(theta_));
				}
			}
		);
		Object.defineProperty(cameraContainer.ang, 'theta', {
				get: function() {return cameraContainer.ang._theta;},
				set: function(theta_) {
					var phi_
					cameraContainer.ang._theta = theta_;
					phi_ = cameraContainer.ang._phi;
					cameraContainer.rotation.set(0, -cameraContainer.ang._theta, cameraContainer.ang._phi);
					cameraContainer.position.set(20 * Math.cos(phi_) * Math.cos(theta_), 20 * Math.sin(phi_) * Math.cos(theta_), 20 * Math.sin(theta_));
				}
			}
		);
		scene.add(cameraContainer);

		// create grid
		var gridGeom;
		gridGeom = new THREE.Geometry();
		var gridMat = new THREE.LineBasicMaterial({color: 0xdddddd, shading: THREE.FlatShading});
		var i;
		var lineGeom, line;
		for (i = -10; i <= 10; i++) {
			lineGeom = new THREE.Geometry();
			lineGeom.vertices.push(new THREE.Vector3(i, -10, 0));
			lineGeom.vertices.push(new THREE.Vector3(i, 10, 0));
			line = new THREE.Line(lineGeom, gridMat);
			scene.add(line);
		}
		for (i = -10; i <= 10; i++) {
			lineGeom = new THREE.Geometry();
			lineGeom.vertices.push(new THREE.Vector3(-10, i, 0));
			lineGeom.vertices.push(new THREE.Vector3(10, i, 0));
			line = new THREE.Line(lineGeom, gridMat);
			scene.add(line);
		}
		
		// create axes
		var xAxis, yAxis, zAxis;
		xAxis = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(0, 0, 0), 1.5, 0xaa0000, 0.4, 0.3);
		yAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(0, 0, 0), 1.5, 0x00aa00, 0.4, 0.3);
		zAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(0, 0, 0), 1.5, 0x0000aa, 0.4, 0.3);
		xAxis.line.material.linewidth = 2.5;
		yAxis.line.material.linewidth = 2.5;
		zAxis.line.material.linewidth = 2.5;
		scene.add(xAxis);
		scene.add(yAxis);
		scene.add(zAxis);

		// create lights
		var light = new THREE.SpotLight( 0xffffff, 1.5 );
		light.position.set( 400, 500, 2000 );
		light.castShadow = true;
		light.shadowCameraNear = 0;
		light.shadowCameraFar = camera.far;
		light.shadowCameraFov = 50;
		light.shadowBias = -0.00022;
		light.shadowDarkness = 0.5;
		light.shadowMapWidth = 2048;
		light.shadowMapHeight = 2048;
		scene.add( light );
		
		var ambientLight = new THREE.AmbientLight(0x505050);
		scene.add(ambientLight);
		
		var previewMaterial = new THREE.MeshPhongMaterial({color: 0x0099ee, shading: THREE.FlatShading, ambient: 0x0022ee, transparent: true, opacity: 0.5});
		var mainMaterial = new THREE.MeshPhongMaterial({color: 0x0099ee, shading: THREE.FlatShading, ambient: 0x0022ee});
		
		// create empty geometry
		var selectedObject = new THREE.Mesh(
			new THREE.Geometry(),
			previewMaterial
		);
		//selectedObject.geometry.dynamic = true;
		
		var currentInput = {};
		
		var Tool = function(name, inputs, getShape) {
			this.name = name;
			this.inputs = inputs;
			this.getShape = getShape;
		}
		this.prototype = new Object(); // This could be left out 
		
		var boxTool = new Tool(
			'Box',
			{Depth: 1, Width: 1, Height: 1},
			function() {
				var newObj = new THREE.Mesh(
					new THREE.BoxGeometry(currentInput.Depth, currentInput.Width, currentInput.Height),
					previewMaterial
				);
				newObj.position.set(currentInput.Depth/2, currentInput.Width/2, currentInput.Height/2);
				return newObj;
			}
		);
		
		var sphereTool = new Tool(
			'Sphere',
			{Radius: 1},
			function() {
				var newObj = new THREE.Mesh(
					new THREE.SphereGeometry(currentInput.Radius, 24, 18),
					previewMaterial
				);
				return newObj;
			}
		);
		
		var cylinderTool = new Tool(
			'Cylinder',
			{Radius: 1, Height: 1},
			function() {
				var newObj = new THREE.Mesh(
					new THREE.CylinderGeometry(currentInput.Radius, currentInput.Radius, currentInput.Height, 24),
					previewMaterial
				);
				newObj.position.y = currentInput.Height/2;
				return newObj;
			}
		);
		
		var coneTool = new Tool(
			'Cone',
			{'Bottom Radius': 1, 'Top Radius': 0.5, Height: 1},
			function() {
				var newObj = new THREE.Mesh(
					new THREE.CylinderGeometry(currentInput['Bottom Radius'], currentInput['Top Radius'], currentInput.Height, 24),
					previewMaterial
				);
				newObj.position.y = currentInput.Height/2;
				return newObj;
			}
		);
		
		var icosahedronTool = new Tool(
			'Icosah.',
			{Radius: 1,},
			function() {
				var newObj = new THREE.Mesh(
					new THREE.IcosahedronGeometry(currentInput.Radius),
					previewMaterial
				);
				return newObj;
			}
		);
		
		var selectTool = new Tool(
			'Select',
			{},
			function() {return new THREE.Mesh(new THREE.Geometry(), new THREE.Material())}
		);
		
		addToolButton(boxTool);
		addToolButton(sphereTool);
		addToolButton(cylinderTool);
		addToolButton(coneTool);
		addToolButton(icosahedronTool);
		
		var activeTool;
		var preview;
		
		var onInputChange = function() {
			// update the preview
			scene.remove(preview);
			preview = activeTool.getShape();
			scene.add(preview);
			renderer.render(scene, camera);
		};
		
		var onchangeFactory = function(inputName, inputField) {
			return function() {
				currentInput[inputName] = parseFloat(inputField.value);
				onInputChange();
			};
		};
		
		var activateTool = function(tool) {
			activeTool = tool;
			
			// remove all inputs
			while (toolOptions.firstChild) {
				toolOptions.removeChild(toolOptions.firstChild);
			}
			
			toolOptions.innerHTML = '<p style="font-size:18px">' + tool.name + ':</p>';
			toolOptions.style.padding = '10px';
			for (var inputName in tool.inputs) {
				if (tool.inputs.hasOwnProperty(inputName)) {
					var label = document.createElement('div');
					label.innerHTML = inputName;
					toolOptions.appendChild(label);
					var inputField = document.createElement('input');
					inputField.type = 'number';
					inputField.value = tool.inputs[inputName];
					inputField.style.borderWidth = '1px';
					inputField.style.borderStyle = 'solid';
					inputField.style.margin = '3px';
					inputField.style.width = '80px';
					currentInput[inputName] = parseFloat(inputField.value);
					inputField.onchange = onchangeFactory(inputName, inputField);
					
					toolOptions.appendChild(inputField);
				}
			}
			onInputChange();
		}
		
		window.addEventListener(
			'resize',
			function(event) {
				// update aspect ratios
				camera.aspect = (window.innerWidth - 200) / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize((window.innerWidth - 200), window.innerHeight);
				renderer.render(scene, camera);
				},
			false
		);

		var mouseDragStart;
		mouseDragStart = {x:0, y:0, z:0};

		var mouse2D = new THREE.Vector3(1, 1, 1);

		document.addEventListener(
			'mousedown',
			function(event) {
				// store the normalized mouse position
				mouseDragStart.x = mouse2D.x;
				mouseDragStart.y = mouse2D.y;
				if (event.button === 0) {
					lmbdown = true;
				}
			},
			false
		);

		document.addEventListener(
			'mouseup',
			function(event) {
				if (event.button === 0) {
					lmbdown = false;
				}
			},
			false
		);
		
		renderer.domElement.addEventListener(
			'mousemove',
			function(event) {
				mouse2D.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse2D.y = - (event.clientY / window.innerHeight) * 2 + 1;
				var dx, dy;
				dx = mouse2D.x - mouseDragStart.x;
				dy = mouse2D.y - mouseDragStart.y;
				mouseDragStart.x = mouse2D.x;
				mouseDragStart.y = mouse2D.y;
				if (!lmbdown) {
					return;
				}
				cameraContainer.ang.phi -= dx * 150/180*Math.PI;
				cameraContainer.ang.theta -= dy * 150/180*Math.PI;
				renderer.render(scene, camera);
			},
			false
		);
		
		document.addEventListener(
			'keydown',
			function(event) {
				if (event.which === 39) {
					cameraContainer.ang.phi += 0.04;
					renderer.render(scene, camera);
				} else if (event.which === 37) {
					cameraContainer.ang.phi -= 0.04;
					renderer.render(scene, camera);
				} else if (event.which === 38) {
					cameraContainer.ang.theta += 0.04;
					renderer.render(scene, camera);
				} else if (event.which === 40) {
					cameraContainer.ang.theta -= 0.04;
					renderer.render(scene, camera);
				}
			},
			false
		);
		renderer.render(scene, camera);
		</script>
	</body>
</html>